# Verificación de modo de lenguaje
if ($ExecutionContext.SessionState.LanguageMode -ne "FullLanguage") {
    Write-Host "`n[ERROR] PowerShell no está en modo Full Language" -ForegroundColor Red
    Write-Host "Este script requiere permisos elevados y modo no restringido."
    Write-Host "Solución: Ejecutar como Administrador y revisar políticas de ejecución"
    Write-Host "Más información: https://massgrave.dev/fix_powershell`n" -ForegroundColor Cyan
    pause
    exit
}

# Configuración de seguridad
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12, [Net.SecurityProtocolType]::Tls13

# Configuración personalizable
$config = @{
    DownloadPath = "$env:TEMP\DescargasApps"
    MaxRetries = 2
    Downloads = @(
        @{Name = "Office"; URL = "https://c2rsetup.officeapps.live.com/c2r/download.aspx?ProductreleaseID=O365ProPlusRetail&platform=x64&language=es-es&version=O16GA"; FileName = "OfficeSetup.exe"},
        @{Name = "Photoshop"; URL = "https://store8.gofile.io/download/web/4afdf269-c6d4-4652-bcb9-15ef56772dfb/AP2025.v26.0.x64.ZDescargasORG.rar"; FileName = "prueba"},
        @{Name = "Activador Office"; ID = "GD_ACT_OFFICE_ID"; FileName = "ActivadorOffice.exe"},
        @{Name = "Activador Photoshop"; ID = "GD_ACT_PHOTOSHOP_ID"; FileName = "ActivadorPhotoshop.exe"}
    )
    ActivationHashes = @{
        MAS_AIO = '16F0FFCDD242A0D514B9D96AE1535F48A2E2811D45A8094E98BB0A26EA2FEBBA'
    }
}

# Inicialización de entorno
if (-not (Test-Path $config.DownloadPath)) {
    New-Item -Path $config.DownloadPath -ItemType Directory | Out-Null
}

# Función mejorada de descarga para manejar archivos grandes de Google Drive y Gofile
function Download-File {
    param(
        [string]$URL,
        [string]$FileName
    )
    
    $output = Join-Path $config.DownloadPath $FileName
    
    try {
        for ($i = 0; $i -le $config.MaxRetries; $i++) {
            try {
                Write-Host "`nDescargando $FileName..." -ForegroundColor Cyan
                $ProgressPreference = 'SilentlyContinue'
                
                # Verificar si el archivo ya existe
                if (Test-Path $output) {
                    Write-Host "El archivo ya existe en $output. Saliendo..." -ForegroundColor Yellow
                    return $true
                }
                
                # Manejo especial para Google Drive (archivo grande)
                if ($URL -match "drive\.google\.com") {
                    # Realizar la solicitud inicial
                    $response = Invoke-WebRequest -Uri $URL -SessionVariable session -UseBasicParsing
                    $headers = $response.Headers
                    
                    # Verificar si se necesita la confirmación para archivos grandes
                    if ($headers['Content-Disposition'] -match 'filename=".*"') {
                        Write-Host "Descargando directamente desde Google Drive..." -ForegroundColor Cyan
                        Invoke-WebRequest -Uri $URL -WebSession $session -UseBasicParsing -OutFile $output
                    } else {
                        # Obtener el enlace de confirmación para archivos grandes
                        $confirmURL = ($response.Links | Where-Object { $_.outerHTML -match "confirm=" }).href
                        if ($confirmURL) {
                            Write-Host "Confirmación requerida en Google Drive, obteniendo enlace..." -ForegroundColor Cyan
                            Invoke-WebRequest -Uri $confirmURL -WebSession $session -UseBasicParsing -OutFile $output
                        } else {
                            Write-Host "No se pudo obtener el enlace de confirmación de Google Drive." -ForegroundColor Red
                        }
                    }
                } 
                # Manejo para Gofile (y otros enlaces directos)
                elseif ($URL -match "gofile\.io") {
                    Write-Host "Descargando directamente desde Gofile..." -ForegroundColor Cyan
                    Invoke-WebRequest -Uri $URL -UseBasicParsing -OutFile $output
                }
                else {
                    # Si no es Google Drive ni Gofile, proceder con la descarga estándar
                    Invoke-WebRequest -Uri $URL -UseBasicParsing -OutFile $output
                }
                
                # Verificar si el archivo se descargó correctamente
                if (Test-Path $output) {
                    Write-Host "Descarga exitosa: $output" -ForegroundColor Green
                    return $true
                } else {
                    Write-Host "La descarga falló, el archivo no se encuentra." -ForegroundColor Red
                }
            }
            catch {
                Write-Host "Intento $($i+1) fallido: $($_.Exception.Message)" -ForegroundColor Yellow
            }
        }
        return $false
    }
    finally {
        $ProgressPreference = 'Continue'
    }
}

# Menú interactivo
function Show-AdvancedMenu {
    Clear-Host
    Write-Host "`n════════════════════════════════════" -ForegroundColor Magenta
    Write-Host "        MENÚ PRINCIPAL v2.1" -ForegroundColor White
    Write-Host "════════════════════════════════════" -ForegroundColor Magenta
    for ($i = 0; $i -lt $config.Downloads.Count; $i++) {
        Write-Host "$($i+1). Descargar $($config.Downloads[$i].Name)"
    }
    Write-Host "$($config.Downloads.Count+1). Activar Windows/Office"
    Write-Host "$($config.Downloads.Count+2). Abrir carpeta de descargas"
    Write-Host "$($config.Downloads.Count+3). Salir"
    Write-Host "════════════════════════════════════`n" -ForegroundColor Magenta
}

# Bucle principal
while ($true) {
    Show-AdvancedMenu
    $selection = Read-Host "Seleccione una opción"
    
    switch ($selection) {
        "1" {
            $office = $config.Downloads | Where-Object { $_.Name -eq "Office" }
            if (Download-File -URL $office.URL -FileName $office.FileName) {
                Write-Host "`n¿Desea abrir la carpeta? (S/N)" -ForegroundColor Cyan
                if ((Read-Host) -eq 'S') { Invoke-Item $config.DownloadPath }
            }
        }
        "2" {
            $photoshop = $config.Downloads | Where-Object { $_.Name -eq "Photoshop" }
            if (Download-File -URL $photoshop.URL -FileName $photoshop.FileName) {
                Write-Host "`n¿Desea abrir la carpeta? (S/N)" -ForegroundColor Cyan
                if ((Read-Host) -eq 'S') { Invoke-Item $config.DownloadPath }
            }
        }
        "3" {
            # Lógica para Activador Office
        }
        "4" {
            # Lógica para Activador Photoshop
        }
        "5" {
            # Lógica para activación
        }
        "6" {
            Invoke-Item $config.DownloadPath
        }
        "7" {
            exit
        }
        default {
            Write-Host "Opción inválida" -ForegroundColor Red
        }
    }
    
    Write-Host "`nPresione Enter para continuar..."
    [Console]::ReadLine()
}

# Abrir cmd al finalizar
Start-Process cmd.exe
